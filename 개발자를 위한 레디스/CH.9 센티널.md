# CH.9 센티널

## 고가용성 기능의 필요성
1. 복제본 노드에 직접 접속한 뒤 `REPLICA OF NO ONE` 커맨드를 입력해 읽기 전용 상태 해제
2. 애플리케이션 코드에서 레디스의 엔드포인트를 복제본의 IP로 변경
3. 배포
- 만약 운영 환경에서 별다른 고가용성 기능의 도입 없이 위와 같은 복제 구성으로만 레디스를 사용하고 있었다면 마스터 노드에 발생한 장애처리가 지연돼 곧바로 서비스 기능의 문제로 이어질 수 있다.
- look aside 구성에서는 애플리케이션이 캐시에 접근할 수 없을 때 직접 MySQL과 같은 원본 데이터 소스에서 데이터를 읽어오려고 시도한다.
- 레디스에서 데이터를 요청하던 세션들이 모두 원본 소스에 집중되면 서버 부하가 급증하고, 급격한 커넥션 증가는 운영 중인 서비스에 영향을 끼칠 수 있기 때문이다.
## 센티널이란?
- 센티널은 데이터를 저장하는 기존 레디스 인스턴스와는 다른 역할을 하는 별도의 프로그램이며, 센티널의 자동 페일오버 기능을 사용하면 마스터 인스턴스에 장애가 발생하더라도 레디스를 계속 사용할 수 있도록 동작해 레디스의 다운타임을 최소화할 수 있다.
### 센티널 기능
- 모니터링 : 마스터, 복제본 인스턴스의 상태를 실시간으로 확인한다.
- 자동 페일오버 : 마스터의 비정상 상태를 감지해 정상 상태의 복제본 중 하나를 마스터로 승격시킨다. 기존 마스터에 연결된 복제본은 새롭게 승격된 마스터에 연결된다.
- 인스턴스 구성 정보 안내 : 센티널은 클라이언트에게 현재 구성에서의 마스터 정보를 알려준다. 페일오버가 발생하면 변경된 마스터 정보를 재전달하기 때문에 페일오버가 발생하더라도 레디스의 엔드포인트 정보를 변경할 필요가 없다.
### 분산 시스템으로 동작하는 센티널
- SPOF(Single Point of Failure)는 하나의 서비스에 문제가 발생했을 때 전체 시스템이 영향을 받는 지점을 뜻한다.
- 복제와 자동 페일오버를 이용해 고가용성을 확보하는 이유는 레디스가 SPOF가 되는 것을 방지하기 위함이다.
- 센티널은 그 자체로 SPOF가 되는 것을 방지하기 위해 최소 3대 이상일 때 정상적으로 동작할 수 있도록 설계됐으며, 하나의 센티널에 이상이 생기더라도 다른 센티널이 계속해서 역할을 수행할 수 있게 된다.
- 클라이언트는 센티널에 먼저 연결해 마스터의 정보를 받아 온다.
- 만약 마스터와 복제본 인스턴스가 정상 상태지만 센티널 인스턴스에 문제가 생겨 마스터 정보를 반환할 수 없게 된다면 클라이언트는 레디스로 새로운 커넥션을 맺을 수 없게 된다.
- 하지만 3대의 센티널이 동작하기 때문에 하나의 센티널에 문제가 생기더라도 클라이언트는 다른 센티널에서 마스터의 정보를 정상적으로 받아올 수 있다.
- 쿼럼은 마스터가 비정상 동작을 한다는 것에 동의해야 하는 센티널의 수로, 쿼럼을 만족하는 경우 페일오버를 시작한다.
- 일반적으로 센티널 인스턴스가 3개일 때 쿼럼은 2로 설정하며, 이 경우 최소 2개 이상의 센티널 인스턴스가 마스터 비정상 상태에 동의한다면 페일오버 프로세스를 시작시킨다.
### 센티널 인스턴스 배치 방법
- 센티널 인스턴스는 물리적으로 서로 영향받지 않는 서버에서 실행되는 것이 좋다.
```text
                   ┌─────────────────┐
                   │   Server A      │
                   │  ┌───────────┐  │
                   │  │  Redis    │  │
                   │  │  Master   │  │
                   │  └───────────┘  │
                   │  ┌───────────┐  │
                   │  │ Sentinel  │  │
                   │  └───────────┘  │
                   └─────────────────┘
                            │
              ┌─────────────┴─────────────┐
              │                           │
    ┌─────────────────┐         ┌─────────────────┐
    │   Server B      │         │   Server C      │
    │  ┌───────────┐  │         │  ┌───────────┐  │
    │  │  Redis    │  │         │  │  Redis    │  │
    │  │  Replica  │  │         │  │  Replica  │  │
    │  └───────────┘  │         │  └───────────┘  │
    │  ┌───────────┐  │         │  ┌───────────┐  │
    │  │ Sentinel  │  │         │  │ Sentinel  │  │
    │  └───────────┘  │         │  └───────────┘  │
    └─────────────────┘         └─────────────────┘

```
- 서버 A에 문제가 생겨 마스터 노드와 센티널에 접근할 수 없게 되면 서버 B, C에 있는 센티널 인스턴스가 마스터 인스턴스에 접근이 불가능한 상태라는 것을 동의한 뒤, 페일오버를 진행시킨다.
```text
                  ┌─────────────────┐
                  │   Server A      │
                  │  ┌───────────┐  │
                  │  │  Redis    │  │
                  │  │  Master   │  │ (장애 발생)
                  │  └───────────┘  │
                  │  ┌───────────┐  │
                  │  │ Sentinel  │  │
                  │  └───────────┘  │
                  └─────────────────┘

    ┌─────────────────┐         ┌─────────────────┐
    │   Server B      │────────>│   Server C      │
    │  ┌───────────┐  │         │  ┌───────────┐  │
    │  │  Redis    │  │ Promote │  │  Redis    │  │
    │  │  Master   │  │<────────│  │  Replica  │  │
    │  └───────────┘  │         │  └───────────┘  │
    │  ┌───────────┐  │         │  ┌───────────┐  │
    │  │ Sentinel  │  │         │  │ Sentinel  │  │
    │  └───────────┘  │         │  └───────────┘  │
    └─────────────────┘         └─────────────────┘
```
- 서버 B와 C의 센티널 인스턴스는 새롭게 마스터가 될 복제본을 선출한 뒤, 해당 복제본 인스턴스를 마스터로 승격시킨다.
- 서버 C의 복제본 노드는 서버 B를 바라보도록 복제 연결을 변경한다.
- 서버 A가 복구된다면 센티널 인스턴스들은 기존 마스터였던 서버 A의 레디스 인스턴스를 새롭게 마스터가 된 서버 B의 복제본이 되도록 연결시킨다.
- 이 과정은 센티널 인스턴스의 판단으로 자동으로 구성되며, 운영자의 개입이 필요하지 않다.
```text
                    ┌─────────────────┐
              ┌────>│   Server A      │
              │     │  ┌───────────┐  │
              │     │  │  Redis    │  │
              │     │  │  Replica  │  │
              │     │  └───────────┘  │
              │     │  ┌───────────┐  │
              │     │  │ Sentinel  │  │
              │     │  └───────────┘  │
              │     └─────────────────┘
              │
    ┌─────────────────┐         ┌─────────────────┐
    │   Server B      │────────>│   Server C      │
    │  ┌───────────┐  │         │  ┌───────────┐  │
    │  │  Redis    │  │         │  │  Redis    │  │
    │  │  Master   │  │         │  │  Replica  │  │
    │  └───────────┘  │         │  └───────────┘  │
    │  ┌───────────┐  │         │  ┌───────────┐  │
    │  │ Sentinel  │  │         │  │ Sentinel  │  │
    │  └───────────┘  │         │  └───────────┘  │
    └─────────────────┘         └─────────────────┘
                    quorum: 2
```
- 경우에 따라 1개의 복제본으로도 충분한 서비스가 있을 수 있다.
- 이럴 경우 2대의 서버에는 레디스와 센티널 인스턴스를 동시에 실행시키고, 나머지 1대의 서버에는 센티널 프로세스만 실행시키도록 배치할 수 있다.
```text
    ┌─────────────────┐         ┌─────────────────┐
    │   Server A      │         │   Server B      │
    │  ┌───────────┐  │         │  ┌───────────┐  │
    │  │  Redis    │  │         │  │  Redis    │  │
    │  │  Master   │  │         │  │  Replica  │  │
    │  └───────────┘  │         │  └───────────┘  │
    │  ┌───────────┐  │         │  ┌───────────┐  │
    │  │ Sentinel  │  │         │  │ Sentinel  │  │
    │  └───────────┘  │         │  └───────────┘  │
    └─────────────────┘         └─────────────────┘
                  ┌─────────────────┐
                  │   Server C      │
                  │  ┌───────────┐  │
                  │  │ Sentinel  │  │
                  │  └───────────┘  │
                  └─────────────────┘
                       quorum: 2
```
- 서버 A에 문제가 생겨 마스터 노드와 센티널에 접근할 수 없게 되면 서버 B, C에 있는 센티널 인스턴스가 마스터 인스턴스에 접근이 불가능한 상태라는 것을 동의한 뒤, 페일오버를 진행시킨다.
```text
    ┌─────────────────┐         ┌─────────────────┐
    │   Server A      │         │   Server B      │
    │  ┌───────────┐  │         │  ┌───────────┐  │
    │  │  Redis    │  │         │  │  Redis    │  │
    │  │  Master   │  │ (장애)   │  │  Master   │  │
    │  └───────────┘  │         │  └───────────┘  │
    │  ┌───────────┐  │         │  ┌───────────┐  │
    │  │ Sentinel  │  │         │  │ Sentinel  │  │
    │  └───────────┘  │         │  └───────────┘  │
    └─────────────────┘         └─────────────────┘
                  ┌─────────────────┐
                  │   Server C      │
                  │  ┌───────────┐  │
                  │  │ Sentinel  │  │
                  │  └───────────┘  │
                  └─────────────────┘
                       quorum: 2
```
## 센티널 인스턴스 실행하기
```text
  ┌─────────────────┐         ┌─────────────────┐
  │ 192.168.0.11    │         │ 192.168.0.22    │
  │  ┌───────────┐  │         │  ┌───────────┐  │
  │  │  Redis    │  │         │  │  Redis    │  │
  │  │  Master   │  │         │  │  Replica  │  │
  │  └───────────┘  │         │  └───────────┘  │
  │  ┌───────────┐  │         │  ┌───────────┐  │
  │  │ Sentinel  │  │         │  │ Sentinel  │  │
  │  └───────────┘  │         │  └───────────┘  │
  └─────────────────┘         └─────────────────┘
                ┌─────────────────┐
                │ 192.168.0.33    │
                │  ┌───────────┐  │
                │  │ Sentinel  │  │
                │  └───────────┘  │
                └─────────────────┘
                    quorum: 2
                 Redis Port: 6379
               Sentinel Port: 26379
```
### 센티널 프로세스 실행
- 센티널 프로세스를 실행하기 전 마스터와 복제본 노드 간 복제 연결이 된 상태로 만들어주자.
```shell

REPLICAOF 192.168.0.11 6379
```
- 센티널 프로세스를 띄우기 위해서는 `sentinel.conf`라는 별도의 구성 파일이 필요하다.
```shell

port 26379
sentinel monitor master-test 192.168.0.11 6379 2
```
- sentinel monitor는 모니터링할 마스터의 이름을 지정하고, 마스터에 이름을 부여하며, 쿼럼 값을 지정한다.
- 센티널은 마스터와 복제본을 포함한 모든 레디스 프로세스를 모니터링하지만, 구성 파일에는 복제본 정보를 직접 입력하지 않아도 된다.
- 센티널 프로세스가 시작하면 마스터에 연결된 복제본을 자동으로 찾아내는 과정을 거친다.
- 센티널은 다음 두 가지 방법을 이용해 실행시킬 수 있다.
```shell

# redis-sentine1을 이용하는 방법
redis-sentinel /path/to/sentinel. conf
# redis-server를 이용하는 방법
redis-server /path/to/sentinel.conf --sentinel
```
- 레디스 프로세스에 접근할 때와 같이 레디스 커맨드라인 클라이언트인 redis-cli를 이용해 센티널 인스턴스에 직접 접근할 수 있다.
```shell

$ redis-cli -p 26379
```
- 센티널 인스턴스에 접속하면 센티널이 모니터링하고 있는 마스터와 복제본 노드의 정보 그리고 복제본을 함께 모니터링하고 있는 다른 센티널 인스턴스에 대한 정보를 확인할 수 있다.
```shell

SENTINEL master <master-name>
```
- SENTINEL master 커맨드를 이용하면 원하는 마스터의 IP, 포트, 연결된 복제본의 개수 등 다양한 정보를 확인할 수 있다.
```shell

sentinel> SENTINEL master master-test
1) "name"
2) "master-test"
3) "ip"
4) "192.168.0.11"
5) "port"
6) "6379"
7) "runid"
8) "953aeбa589449c13ddefaee3538d356d287f509b"
9) "flags"
10) "master"
11) "link-pending-commands"
12) "0"
13) "link-refcount"
14) "1"
15) "last-PING-sent"
16) "0"
17) "last-ok-PING-reply"
18) "735"
19) "last-PING-reply"
20) "735"
21) "down-after-milliseconds"
22) "5000"
23) "info-refresh"
24) "126"
25) "role-reported"
26) "master"
27) "role-reported-time"
28) "532439"
29) "config-epoch"
30) "1"
31) "num-slaves"
32) "1"
33) "num-other-sentinels"
34) "2"
35) "quorum"
36) "2"
37) "failover-timeout"
38) "60000"
39) "parallel-syncs"
40) "1"
```
- num-other-sentinels 값은 마스터를 모니터링하고 있는 다른 센티널의 정보를 나타낸다.
- flags 값은 마스터의 상태를 나타낸다. 마스터의 상태가 정상적이지 않다고 판단되면 해당 값이 s_down 또는 o_down 등의 값으로 변경된다.
- num-slaves 값은 현재 마스터에 연결된 복제본의 개수를 나타낸다.
- SENITNEL replicas 커맨드를 이용하면 마스터에 연결된 복제본의 자세한 정보를 확인할 수 있다.
```shell

sentinel> SENTINEL replicas master-test
1) 1) "name"
   2) "192.168.0.22:6379"
   3) "ip"
   4) "192. 168.0.22"
   5) "port"
   6) "6379"
   7) "runid"
   8) "2d4d175cdf692e4e75160ab240e8116f347d411a"
   9) "flags"
   10) "slave"
```
- SENITNEL sentinels 커맨드를 이용하면 마스터에 연결된 복제본의 자세한 정보를 확인할 수 있다.
```shell

sentinel> SENTINEL sentinels master-test
1) 1) "name"
   2) "9c7e2b3e08157dec505f388715fcad90dbcb1572"
   3) "ip"
   4) "192. 168.0.22"
   5) "port"
   6) "26379"
   7) "runid"
   8) "9c7e2b3e08157dec505f388715fcad90dbcb1572"
   9) "flags"
   10) "sentinel"
```
- SENITNEL ckquorum 커맨드를 이용하면 마스터를 바라보고 있는 센티널 인스턴스가 설정한 쿼럼 값보다 큰지 확인할 수 있다.
- 정상 상태의 센티널이 3대, 쿼럼이 2일 경우 센티널 3대 모두 정상이라면 다음과 같은 값을 반환한다.
```shell

sentinel > SENTINEL ckquorum mater-test
OK 3 usable Sentinels. Quorum and failover authorization can be reached
```
- 1대의 센티널에 문제가 생겨 정상적인 센티널이 2대가 됐을 경우
- 정상적인 센티널 대수가 쿼럼 값인 2 이상이기 때문에 전체 센티널 구성은 정상적이라 판단할 수 있다.
```shell

sentinel > SENTINEL ckquorum mater-test
OK 2 usable Sentinels. Quorum and failover authorization can be reached
```
- 이 상황에서 다른 1대의 센티널이 또 비정상적인 상태가 된다면 정상적인 센터널의 수는 1대로, 설정한 쿼럼 값보다 작아지게 된다.
- 레디스 마스터에 장애가 발생해도 쿼럼 이상의 센티널 인스턴스에게 동의를 받을 수 없기 때문에 비정상적인 센티널의 상태라 볼 수 있다.
```shell

sentinel> SENTINEL ckquorum mater-test
(error) NOQUORUM 1 usable Sentinels. Not enough available Sentinels to reach
the specified quorum for this master. Not enough available Sentinels to
reach the majority and authorize a failover
```
### 페일오버 테스트
#### 커맨드를 이용한 페일오버 발생(수동 페일오버)
```shell

SENTINEL FAILOVER <master name>
```
- 센티널에 직접 접속한 뒤 이 커맨드를 사용하면 다른 센티널의 동의를 구하지 않고도 페일오버를 바로 발생시킬 수 있다.
- 실제 마스터의 상태가 정상이었을 때도 이 커맨드를 사용하면 마스터와 복제본 간 롤 체인지가 발생한다.
#### 마스터 동작을 중지시켜 페일오버 발생(자동 페일오버)
- 직접 마스터 노드에 장애를 발생시킨 뒤 페일오버가 잘 발생하는지 확인함으로써 마스터의 상태가 정상이 아닐 경우 센티널에서 이를 인지할 수 있는지 확인할 수 있다.
- 레디스의 프로세스를 직접 셧다운
```shell

$ redis-cli -h <master-host> -p <master-port> shutdown
```
- 센티널은 주기적으로 마스터 노드에 PING을 보내 응답이 정상적으로 돌아오는지 확인함으로 마스터 인스턴스의 상태를 파악한다.
- `sentine1.conf`에 지정한 `down-after-milliseconds` 시간동안 마스터에서 응답이 오지 않으면 마스터의 상태가 정상적이지 않다고 판단해 페일오버를 트리거한다.
- 해당 옵션의 기본값은 30,000밀리초, 즉 30초이므로 센티널은 30초 동안 마스터에서 응답을 받지 못했을 때 마스터의 상태가 비정상이라 판단해 페일오버를 진행시킨다.
## 센티널 운영하기
### 패스워드 인증
- 마스터와 복제본 노드에 requirepass/masterauth 옵션을 이용해 패스워드를 설정한 경우 센티널의 설정 파일에서도 패스워드를 지정해야 한다.
- 센티널을 이용한 구성 에서는 장애상황에 센티널이 자동으로 페일오버를 시키기 때문에 복제구성 내의 모든 레디스 노드는 마스터 노드가 될 가능성이 있다고 볼 수 있다.
- 따라서 하나의 복제 그룹에서 requirepass와 masterauth 값은 모든 노드에서 동일하게 설정해야 한다.
```shell

sentinel auth-pass < master-name> < password>
```
### 복제본 우선순위
- 모든 레디스 인스턴스는 `replica-priority`라는 파라미터를 가지고 있다.
- 센티널은 페일오버를 진행할 때 각 복제본 노드의 `replica-priority`라는 우선순위 노드를 확인하며, 해당 값이 가장 작은 노드를 마스터로 선출한다. 
- 기본값은 100이며, 이 값이 0인 복제본은 절대 마스터로 선출되지 않는다.
### 운영 중 센티널 구성 정보 변경
- 센티널은 실행 도중 모니터링할 마스터를 추가, 제거, 변경할 수 있다.
- 이때 마스터를 모니터링하는 센티널이 여러 대라면 각각의 센티널에 모두 설정을 적용해야 하며, 설정을 변경했다고 해서 그 정보들이 다른 센티널로 전파되진 않는다.
```shell

SENTINEL MONITOR <master name> <ip> <port> <quorum>
```
- `SENTINEL MONITOR` 커맨드는 센티널이 새로운 마스터를 모니터링할 수 있도록 한다.
```shell

SENTINEL REMOVE <master name>
```
- `SENTINEL REMOVE` 커맨드는 더 이상 지정하는 마스터를 모니터링하지 않도록 지시한다.
```shell

SENTINEL SET <name> [<option> <value> ...]
```
- `SENTINEL SET` 커맨드는 특정 마스터에 대해 지정한 파라미터를 변경할 수 있다.
- 예를 들어 마스터가 다운됐다는 것을 판단하는 시간인 `down-after-milliseconds` 값을 변경하고 싶다면 다음과 같은 커맨드를 입력하면 된다.
```shell

sentinel> SENTINEL SET mymaster down-after-milliseconds 1000
OK
```
```shell

sentinel> SENTINEL SET mymaster quorum 1
OK
```
- 마스터에 종속되지 않는 센티널의 고유한 설정값도 런타임 중에 변경할 수 있다.
```shell

SENTINEL CONFIG GET < configuration name>
SENTINEL CONFIG SET < configuration name> <value>
```
```shell

Sentinel> SENTINEL CONFIG GET announce*
1) "announce-hostnames"
2) "no"
3) "announce-ip"
4) ""
5) "announce-port"
6) "0"
```
### 센티널 초기화
- 센티널은 비정상적이라 판단한 복제본 노드에 대해서도 임의로 모니터링을 멈추지 않는다.
- 페일오버된 뒤 계속 접근할 수 없는 기존 마스터 노드, 혹은 장애가 발생해 접근할 수 없는 복제본 노드 등에 대해서도 계속 모니터링을 시도한다.
```text
                  ╔═════════════════╗
              ┌───║ 192.168.0.11    ║───┐
              │   ║  ┌───────────┐  ║   │ (장애 발생)
              │   ║  │  Redis    │  ║   │
              │   ║  │  Master   │  ║   │
              │   ║  └───────────┘  ║   │
              │   ║  ┌───────────┐  ║   │
              │   ║  │ Sentinel  │  ║   │
              │   ║  └───────────┘  ║   │
              │   ╚═════════════════╝   │
              ↓                         ↓
  ┌─────────────────┐         ┌─────────────────┐
  │  192.168.0.22   │         │  192.168.0.33   │
  │  ┌───────────┐  │         │  ┌───────────┐  │
  │  │  Redis    │  │         │  │  Redis    │  │
  │  │  Master   │  │ (승격)   │  │  Replica  │  │
  │  └───────────┘  │         │  └───────────┘  │
  │  ┌───────────┐  │         │  ┌───────────┐  │
  │  │ Sentinel  │  │         │  │ Sentinel  │  │
  │  └───────────┘  │         │  └───────────┘  │
  └─────────────────┘         └─────────────────┘
```
- 192.168.0.11 서버에 장애가 발생한 뒤 192.168.0.22의 레디스가 마스터 노드로 승격된 모습을 나타낸다.
- 192.168.0.22, 192.168.0.33의 센터널은 192.168.0.11에서의 레디스 인스턴스에 대해 주기적으로 PING을 하며 상태를 확인하고 있다.
- 만약 192.168.0.11 서버를 더 이상 사용할 수 없어 해당 인스턴스에 대한 모니터링을 중단하려면 `SENTINEL RESET` 커맨드를 사용해 센티널 인스턴스의 상태 정보를 초기화해야 한다.
```shell

SENTINEL RESET <master name>
```
- 실행중인 센티널 인스턴스에서 RESET 커맨드를 이용하면 센티널 인스턴스의 상태 정보를 초기화하고 센티널이 모니터링하고 있는 마스터, 복제본, 다른 센티널 인스턴스의 정보를 새로 고친다.
### 센티널 노드의 추가/제거
```text
  ┌─────────────────┐         ┌─────────────────┐
  │ 192.168.0.11    │         │ 192.168.0.22    │
  │  ┌───────────┐  │         │  ┌───────────┐  │
  │  │  Redis    │  │         │  │  Redis    │  │
  │  │  Master   │  │         │  │  Replica  │  │
  │  └───────────┘  │         │  └───────────┘  │
  │  ┌───────────┐  │         │  ┌───────────┐  │
  │  │ Sentinel  │  │         │  │ Sentinel  │  │◄───────────┐
  │  └───────────┘  │         │  └───────────┘  │            │
  └─────────────────┘         └─────────────────┘            │
                ┌─────────────────┐              ╔═════════════════╗
                │ 192.168.0.33    │              ║ 192.168.0.44    ║
                │  ┌───────────┐  │              ║  ┌───────────┐  ║ (새 Sentinel 추가)
                │  │ Sentinel  │  │              ║  │ Sentinel  │  ║
                │  └───────────┘  │              ║  └───────────┘  ║
                └─────────────────┘              ╚═════════════════╝
```
- 마스터를 모니터링 하도록 설정한 센티널 인스턴스를 실행시키면 자동검색 메커니즘에 의해 자동으로 기존에 실행 중이던 다른 센티널의 `known-list`에 추가된다.
- 192.168.0.44 센티널이 192.168.0.11의 마스터를 모니터링한다면 자동으로 192.168.0.11, 192.168.0.22에서 실행되고 있는 센티널에서 이를 인지하게 된다.
- 만약 한 번에 여러 대의 센티널을 추가해야 하는 경우 10초 이상의 간격을 두면서 1개 씩 목록에 들어가도록 천천히 추가하는 것이 오류의 발생 가능성을 줄일 수 있는 방법이다.
### 센티널의 자동 페일오버 과정
#### 마스터의 장애 상황 감지
- 센티널은 `down-after-milliseconds` 파라미터에 지정된 값 이상 동안 마스터에 보낸 PING에 대해 유효한 응답을 받지 못하면 마스터가 다운됐다고 판단한다.
- PING에 대한 유효한 응답은 +PONG, -LOADING, -MASTERDONN이며, 다른 응답이나 응답을 아예 받지 못할 경우는 모두 유효하지 않다고 판단한다.
#### sdown, odown 실패 상태로 전환
- 센티널 노드에서 레디스 마스터 인스턴스에 대한 응답을 늦게 받으면 그 센티널은 마스터의 상태를 우선 sdown으로 플래깅한다.
- sdown이란 subjectly down, 즉 주관적인 다운상태를 의미한다.
- 센티널 노드는 다른 센티널 노드들에게 `SENTINEL is-master-down-by-addr 〈master-ip><master-port><Current-epoch> <*>`라는 커맨드를 보내 다른 센티널에게 장애 사실을 전파한다.
- 앞선 커맨드를 받은 센티널들은 해당 마스터 서버의 장애를 인지했는지 여부를 응답한다.
- 자기 자신을 포함해 쿼럼 값 이상의 센티널 노드에서 마스터의 장애를 인지한다면 센티널 노드는 마스터의 상태를 odown으로 변경한다.
- odown이란 objectly down, 즉 객관적인 다운상태가 됐음을 의미한다.
- 센티널은 마스터에 대해서만 odown 상태를 갖는다.
- 센티널은 모든 레디스 노드를 모니터링하기 때문에 복제본 노드에 장애가 발생하는 경우 이를 인지한 뒤 해당 복제본 노드를 sdown으로 플래깅한다.
- 하지만 해당 사실을 다른 센티널 노드로 전파하는 등의 작업을 진행해 복제본을 odown 상태로 변경하지는 않는다.
- 장애 전파는 오직 마스터 노드에 대해서만 이뤄진다.
- 다만 페일오버를 진행할 때 sdown 상태의 복제본은 마스터 승격되도록 선택되지 않는다.
#### 에포크 증가
- 처음으로 마스터 노드를 odown으로 인지한 센티널 노드가 페일오버 과정을 시작한다. 
- 센티널은 페일오버를 시작하기 전 우선 에포크(epoch) 값을 하나 증가시킨다. 
- 센티널은 에포크라는 개념을 이용해 각 마스터에서 발생한 페일오버의 버전을 관리한다.
#### 센티널 리더 선출
- 에포크를 증가시킨 센티널은 다른 센티널 노드에게 센티널 리더를 선출하기 위해 투표하라는 메시지를 보낸다.
- 이때 증가시킨 에포크를 함께 전달하는데, 해당 메시지를 받은 다른 센티널 노드가 현재 자신의 에포크보다 전달받은 에포크가 클 경우 자신의 에포크를 증가시킨 뒤, 센티널 리더에게 투표하겠다는 응답을 보낸다.
- 만약 센티널 노드가 투표 요구를 받았을 때 함께 전달받은 에포크 값이 자신의 에포크 값과 동일할 때에는 이미 리더로 선출한 센티널의 id를 응답한다.
#### 복제본 선정 후 마스터로 승격
- 과반수 이상의 센티널이 페일오버에 동의했다면 리더 센티널은 페일오버를 시도하기 위해 마스터가 될 수 있는 적당한 복제본을 선정한다.
- 이때 마스터로부터 오랜 기간동안 연결이 끊겼던 복제본은 승격될 자격이 없으며, 자격이 있는 복제본은 다음과 같은 순으로 선출된다.
  1. `redis.conf`파일에 명시된 `replica-priority`가 낮은 복제본
  2. 마스터로부터 더 많은 데이터를 수신한 복제본(master_repl_오프셋)
  3. 2번 조건까지 동일하다면, runID가 사전 순으로 작은 복제본
- 선정한 복제본에는 `slaveof no one` 커맨드를 수행해, 기존 마스터로부터의 복제를 끊는다.
#### 복제 연결 변경
- 기존 마스터에 연결돼 있던 다른 복제본이 새로 승격된 마스터의 복제본이 될 수 있도록 복제본마다 `replicaof new-ip new-port` 커맨드를 수행해 복제 연결을 변경한다.
#### 장애 조치 완료
- 모든 과정이 완료된 뒤 센티널은 새로운 마스터를 모니터링한다.
### 스플릿 브레인 현상
- 스플릿 브레인(split brain)이란 네트워크 파티션 이슈로 인해 분산환경의 데이터 저장소가 끊어지고, 끊긴 두 부분이 각각을 정상적인 서비스라고 인식하는 현상을 의미한다.
- 네트워크 단절이 길어지면 센티널 B와 C는 마스터 노드로의 접근이 정상적이지 않다는 것을 감지한 뒤, 복제본 노드를 마스터로 승격시키게 된다.
- 과반수 이상의 센티널이 같은 네트워크 파티션에 존재하기 때문에 복제본 노드는 마스터 노드로 승격될 수 있다.
- 만약 마스터 인스턴스에는 장애가 발생 하지 않았으며, 단지 노드 간 네트워크 단절이 일어난 경우라면 하나의 복제본에 2개의 마스터가 생기는 스플릿 브레인 현상이 일어난다.
- 클라이언트는 레디스에 연결할 때 센티널에 마스터 주소를 질의한 뒤 곧바로 마스터 인스턴스에 직접 연결된다.
- 따라서 기존에 마스터 노드에 연결됐던 클라이언트가 네트워크 단절에 영향을 받지 않았다면 계속해서 기존 마스터 인스턴스에 데이터를 입력한다.
- 이 경우 새로 레디스로 연결하고자 하는 클라이언트가 센티널 C에 마스터 주소를 물어본다면 센티널은 새롭게 마스터로 승격된 주소를 반환한다.
- 클라이언트는 새로운 마스터에 데이터를 쓰게 된다.
- 만약 네트워크 단절이 복구된다면 기존 마스터는 센티널 B,C에 의해 새롭게 승격된 마스터의 복제본으로 연결된다.
- 복제본으로 연결되는 과정에서 복제본 노드의 데이터는 모두 삭제되기 때문에 기존 마스터가 네트워크 단절동안 처리했던 모든 데이터는 유실된다.
- 클라이언트는 레디스에 데이터를 입력했는데, 입력된 데이터는 찾을 수 없는 상황이 발생할 수 있다.