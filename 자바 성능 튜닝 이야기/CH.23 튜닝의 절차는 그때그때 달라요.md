# CH.23 튜닝의 절차는 그때그때 달라요.
## 성능튜닝을 위한 아주 기초법칙
- 아무리 최적화된 시스템이라고 할지라도 생각지도 못한 부분의 성능저하는 발생할 수 밖에 없다.
## 성능튜닝 step by step
1. 원인 파악 
2. 목표 설정 
3. 튜닝 실시 
4. 개선율 확인 
5. 결과 정리 및 반영
### 원인 파악
- 어디가 병목인지 확실히 파악하여 원인을 찾아야 한다.
### 목표 설정
- 성능 개선뿐만 아니라, 향후 유지보수까지 모두 고려해서 목표를 설정하는 것이 좋다.
### 튜닝 실시
- 튜닝을 실시하는 가장 좋은 방법은 프로파일링 툴이나 APM과 같은 툴을 사용하는 것이고, 개선이 얼마나 되었는지를 확인하려면 JMH나 캘리퍼와 같은 성능비교도구를 사용하는 것도 큰 도움이 될 수 있다.
### 개선율 확인
- 개선율을 확인한 다음에, 결과가 만족스럽지 않은 경우에는 '튜닝실시' 단계로 다시 넘어가서 진행을 해야한다.
- 원인을 잘못 판단했을 경우 개선율이 아주 낮게 나올수 밖에 없다.
### 결과 정리 및 반영
- 정리가 반드시 필요없다고 하더라도, 아주 간단하게 어딘가에 정리하는 습관을 가져가는 것이 좋다.
## 성능 튜닝의 비법
- 하나만 보지 말아라.
- 큰 놈을 없애라.
- 깊게 알아야 한다.
- 결과 공유는 선택이 아닌 필수!
### 하나만 보지 말아라.
- 필자를 포함한 독자 여러분들이 알고있는 병목지점은 이 세상에 있는 병목지점의 일부분일 뿐이다.
- 성능상 문제를 발생시킬 수 있는 대상은 아주 많다.

| 대상        | 세부 대상 |
|:----------| :--- |
| 서버 장비     | CPU, Network, Disk, Memory 등 |
| 서버 OS     | OS 커널, OS 설정, 수행 중인 프로세스 등 |
| 자바 애플리케이션 | 스레드 풀 설정, DB Connection Pool 설정, Cache 설정, GC 설정, Heap 크기 설정, 검증되지 않은 프레임워크의 버그, 개발된 애플리케이션 등 |
| 웹 서버      | 프로세스 개수 설정, Connector 설정, 개발된 모듈의 버그 등 |
| 네트워크      | 사용자의 네트워크의 종류, 사용자의 위치, L4 및 Switch 등 네트워크 장비, 방화벽 등 |
| 클라이언트     | 클라이언트 장비의 CPU, Network, Disk, Memory, OS 등의 성능, 클라이언트 애플리케이션, 클라이언트 장비에서 수행 중인 프로세스 등 |

### 큰 놈을 없애라.
- 예를 들어 1초가 걸리는 애플리케이션이 있다.
- 이 애플리케이션을 분석해보니 0.2초가 소요되는 메서드 하나를 발견했다.
- 이 메서드를 여러분들이 엄청나게 튜닝해서 속도를 0.00001 초가 되었다. 그래봤자 해당 애플리케이션은 0.80001 초가 될 것이고, 간단하게 생각하면 20%의 성능개선밖에 이루어지지 않는다.
- 어떤 애플리케이션은 1명의 요청을 할 때는 응답이 0.1초로 매우 빠르다.
- 하지만, 운영 상황에서 그 속도가 나온다고 보장할 수 없다.
- 즉, 부하테스트 툴이나 간단히 스레드를 만들어서 부하를 주어 성능측정을 해봐야만 한다.
- 성능튜닝을 하다 보면 중심이 되는 라이브러리에 문제가 발생하는 경우도 적지 않다.
- 이 경우 선택은 두 가지다. 하나는 해당 라이브러리를 튜닝하는 것이고, 다른 하나는 다른 것으로 교체하는 것이다.
- 라이브러리를 튜닝하는 것이 비용상으로 많은 절감을 가져올 수 있겠지만, 그렇게 할 수 없는 경우에는 다른 것으로 교체할 수 밖에 없다.
- 만약 개발이 거의 막바지에 다다랐을 때는 라이브러리를 교체하는 비용이 만만치 않게 될수도 있다.
- 이런 경우가 발생하는 것을 방지하는 가장 좋은 방법은 시스템의 코어 부분이 개발 완료되었을 때 성능테스트를 통해서 사용중인 라이브러리의 성능을 검증하는 것이다.
- 대부분의 프로젝트는 개발을 시작할 때 코어가 되는 부분을 먼저 개발하고, 그 다음에 관련된 기능들을 개발한다. 따라서 이 절차를 따르는 것을 권장한다.
- 서버의 성능도 큰 영향을 미치지만, 해당 애플리케이션을 사용하는 사용자들에게는 클라이언트의 성능도 무시할 수 없다.
- 웹 페이지를 만들었다면, 적어도 브라우저에서 제공하는 개발자 도구를 통해서 해당 애플리케이션의 로딩이 어떻게 되는지 확인해 보기 바란다.
### 깊게 알아야 한다.
- 개발 언어, OS, DB, N/W, 서버 등 대충 알면 대충 튜닝할 수밖에 없다.
- 하지만, 이 모든 것의 전문가가 되기는 어렵다. 그러니 하나라도 전문가가 되어야 한다.
### 결과 공유는 선택이 아닌 필수!
- 잘못하면 오랜 기간동안 힘들게 작업한 것이 인정받지 못할수도 있다.
- 결과 리를 할 때 꼭 포함되어야 하는 내용은 다음과 같다.
  - 개요 : 튜닝을 실시한 배경
  - 튜닝 환경 : 튜닝을 실시하고 성능을 측정한 서버 및 툴에 대한 상세한 내용
  - 튜닝 결과 : 튜닝 전과 후의 결과를 비교
  - 결론 : 어느 부분을 어떻게 변경하는 것이 가장 큰 효과를 줄지, 튜닝작업을 진행한 담당자의 의견 등을 포함
- 튜닝 결과를 정리할 때 몇 가지 유의사항
  - 확실한 결과 위주로 포함하자.
  - 개선 효과가 가장 큰 것부터 나열하자.
  - 개발한 사람의 심기를 나쁘게 하지 말자.
### 그래프를 그릴 때 유의사항
- 대충 의미없이 그래프 30개를 나열하는 것보다는, 그래프 하나로 모든 상황을 볼 수 있도록 그리는 것만큼 예술적인 것은 없다.
- 그래프의 타이틀은 반드시 추가하자. 그렇지 않으면 비슷한 다른 그래프와 혼동될 수도 있다.
- 그래프의 라벨(Label)은 가능하면 X축 하단에 넣자.
- 산포도(Scatter char)를 보여줄 때, 데이터를 나타내는 각 점은 되도록이면 작게 표현하자.
- Y축을 그릴 때,
  - 정수값일 경우 1,000단위에 콤마를 추가해 주자.
  - 소수까지 내려가는 값일 경우 적어도 3자리를 보여주자.
  - 주 단위를 표시하는 경우에는 그래프 내에 주 단위가 4개 이상 표시되지 않는 것이 좋다.
- X축을 그릴 때, X축의 주 단위는 10개 내외로 보여주는 것이 좋다.